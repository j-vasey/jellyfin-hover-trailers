name: Update Plugin Manifest

on:
  release:
    types: [published]

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update Manifest
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $version = $tag.TrimStart('v')
          $manifestPath = "manifest.json"
          
          # 1. Fetch the zip asset URL from the release metadata
          $asset = ${{ toJSON(github.event.release.assets) }} | ConvertFrom-Json | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1
          if (-not $asset) { throw "No .zip asset found in the release!" }
          
          $sourceUrl = $asset.browser_download_url
          
          # 2. Download the zip to calculate MD5 (Jellyfin requirement)
          Invoke-WebRequest -Uri $sourceUrl -OutFile "temp_plugin.zip"
          $hash = (Get-FileHash "temp_plugin.zip" -Algorithm MD5).Hash.ToLower()
          
          # 3. Load existing manifest and prepend new version
          $manifest = Get-Content $manifestPath | ConvertFrom-Json
          
          $newVersion = @{
              version = $version
              targetAbi = "10.11.5" # Update this as needed for your Jellyfin target
              changelog = "${{ github.event.release.body }}"
              checksum = $hash
              sourceUrl = $sourceUrl
              timestamp = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss")
          }

          # Update the versions array for the first plugin in the manifest
          $manifest[0].versions = @($newVersion) + $manifest[0].versions
          
          # 4. Save back to manifest.json with clean formatting
          $manifest | ConvertTo-Json -Depth 10 | Out-File $manifestPath -Encoding utf8

      - name: Commit and Push Manifest Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update manifest for version ${{ github.event.release.tag_name }}"
          file_pattern: 'manifest.json'
