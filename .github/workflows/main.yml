name: Update Plugin Manifest

on:
  release:
    types: [published]

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # Explicitly targets your master branch

      - name: Update Manifest
        shell: pwsh
        env:
          RELEASE_ASSETS: ${{ toJSON(github.event.release.assets) }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          $version = $tag.TrimStart('v')
          $manifestPath = "manifest.json"
          
          # Use Environment variables to avoid ParserErrors
          $assets = $env:RELEASE_ASSETS | ConvertFrom-Json
          $asset = $assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1
          
          if (-not $asset) { exit 1 }
          
          # Download and hash
          $sourceUrl = $asset.browser_download_url
          Invoke-WebRequest -Uri $sourceUrl -OutFile "temp_plugin.zip"
          $hash = (Get-FileHash "temp_plugin.zip" -Algorithm MD5).Hash.ToLower()
          
          # Load existing manifest as an array
          $manifest = Get-Content $manifestPath -Raw | ConvertFrom-Json
          
          $newVersion = @{
              version = $version
              targetAbi = "10.11.5"
              changelog = $env:RELEASE_BODY
              checksum = $hash
              sourceUrl = $sourceUrl
              timestamp = (Get-Date -Format "yyyy-MM-ddTHH:mm:ss")
          }

          # Update the versions list
          $manifest[0].versions = @($newVersion) + $manifest[0].versions
          
          # FORCE ARRAY OUTPUT: The comma is key here
          ,$manifest | ConvertTo-Json -Depth 10 | Out-File $manifestPath -Encoding utf8
          
      - name: Commit and Push Manifest Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: master # Force the commit action to use master
          commit_message: "chore: update manifest for version ${{ github.event.release.tag_name }}"
          file_pattern: 'manifest.json'
          skup_checkout: true
